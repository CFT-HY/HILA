\chapter{HILA Functionality}
\hypertarget{md_docs_2guide_2hila__functionality}{}\label{md_docs_2guide_2hila__functionality}\index{HILA Functionality@{HILA Functionality}}
This section is comprehensive description of the functionality it offers. For technical documentation each class, method, function etc. has been (work in progress) documented with standard docstring documentation which has been generated with doxygen.\hypertarget{md_docs_2guide_2hila__functionality_autotoc_md0}{}\doxysection{\texorpdfstring{Datatypes}{Datatypes}}\label{md_docs_2guide_2hila__functionality_autotoc_md0}

\begin{DoxyItemize}
\item NDIM\+: number of dimensions, values 2,3,4 (TODO\+: NDIM=1?). Typically set in application Makefile
\item Standard types\+: {\ttfamily int}, {\ttfamily int64\+\_\+t}, {\ttfamily float}, {\ttfamily double} ({\ttfamily long double}?)
\item Hila provided basic types\+: {\ttfamily \doxylink{classComplex}{Complex}\textbackslash{}\texorpdfstring{$<$}{<}S\textbackslash{}\texorpdfstring{$>$}{>}}, {\ttfamily Vector\textbackslash{}\texorpdfstring{$<$}{<}n,T\textbackslash{}\texorpdfstring{$>$}{>}}, {\ttfamily \doxylink{classMatrix}{Matrix}\textbackslash{}\texorpdfstring{$<$}{<}n,m,T\textbackslash{}\texorpdfstring{$>$}{>}}, {\ttfamily Square\+Matrix\textbackslash{}\texorpdfstring{$<$}{<}n,T\textbackslash{}\texorpdfstring{$>$}{>}}, {\ttfamily \doxylink{classArray}{Array}\textbackslash{}\texorpdfstring{$<$}{<}n,m,T\textbackslash{}\texorpdfstring{$>$}{>}}

Here S is any standard type, and T includes S and \doxylink{classComplex}{Complex}\texorpdfstring{$<$}{<}S\texorpdfstring{$>$}{>}. C++ or C standard complex types should not be used (not AVX vectorizable). See docs for functions/methods (TODO Doxygen docs)
\item Special types\+:
\begin{DoxyItemize}
\item {\ttfamily Parity}\+: enum with values EVEN, ODD, ALL; refers to parity of the site. Parity of site (x,y,z,t) is even if {\ttfamily (x+y+z+t)} is even, odd otherwise.
\item {\ttfamily Direction}\+: conceptually unit vector with values {\ttfamily ±e\+\_\+x, ±e\+\_\+y, ±e\+\_\+z, ±e\+\_\+t} (if NDIM==4). Implemented as an enum class. Can be used to index arrays of size NDIM.
\item {\ttfamily Coordinate\+Vector}\+: derived from Vector$<$\+NDIM,int$>$.

Direction variable acts as an unit vector in vector algebra\+: (assume below NDIM=4)
\end{DoxyItemize}
\end{DoxyItemize}


\begin{DoxyCode}{0}
\DoxyCodeLine{\mbox{\hyperlink{classCoordinateVector__t}{CoordinateVector}}\ v;}
\DoxyCodeLine{Direction\ d\ =\ e\_x;}
\DoxyCodeLine{v\ =\ d;\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ v\ =\ [1,0,0,0]}}
\DoxyCodeLine{v\ +=\ e\_y\ -\/\ 3*d;\ \ \ \ \textcolor{comment}{//\ v\ =\ [-\/2,1,0,0]}}
\DoxyCodeLine{v\ =\ \{0,1,-\/1,0\};\ \ \ \ \textcolor{comment}{//\ v\ =\ [0,1,-\/1,0]\ equivalent\ v\ =\ e\_y\ -\/\ e\_z;}}
\DoxyCodeLine{\mbox{\hyperlink{namespacehila_a7d333681d94db8e9eac675f2a7b5e3e6}{hila::out0}}\ <<\ v.dot(\{1,2,3,4\});\ \ \textcolor{comment}{//\ dot\ product\ of\ 2\ vectors,\ prints\ -\/1}}
\DoxyCodeLine{\textcolor{keywordtype}{int}\ j\ =\ d;\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ ok}}
\DoxyCodeLine{d\ =\ j;\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ ERROR:\ cannot\ assign\ int\ to\ Direction}}
\DoxyCodeLine{++d;\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ e\_x\ -\/>\ e\_y}}
\DoxyCodeLine{is\_up\_dir(d);\ \ \ \ \ \ \textcolor{comment}{//\ true\ if\ d\ is\ along\ positive\ x,y,z,t\ -\/dir.}}

\end{DoxyCode}
\hypertarget{md_docs_2guide_2hila__functionality_autotoc_md1}{}\doxysection{\texorpdfstring{Field access and traversal}{Field access and traversal}}\label{md_docs_2guide_2hila__functionality_autotoc_md1}
The principal traversal of the lattice is with {\itshape site loops} {\ttfamily onsites(\+Parity)}, and a special location identifier {\ttfamily X} (effectively a new keyword). ~\newline



\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{keyword}{using\ }mytype\ =\ \mbox{\hyperlink{classMatrix}{Matrix<3,3,Complex<double>}}>;\ \ \ \textcolor{comment}{//\ use\ type\ alias}}
\DoxyCodeLine{\mbox{\hyperlink{classField}{Field<mytype>}}\ f,g,h;}
\DoxyCodeLine{.\ .\ .}
\DoxyCodeLine{}
\DoxyCodeLine{onsites(ALL)\ f[X]\ =\ 2\ +\ g[X];\ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ 2\ acts\ as\ 2*I\ for\ square\ matrices}}
\DoxyCodeLine{f[ALL]\ =\ 2\ +\ g[X];\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ equivalent\ shorter\ form\ for\ simple\ 1-\/line\ assignments}}
\DoxyCodeLine{f\ =\ 2\ +\ g;\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ this\ is\ also\ equivalent!}}
\DoxyCodeLine{}
\DoxyCodeLine{parity\ p\ =\ EVEN;}
\DoxyCodeLine{Direction\ d\ =\ e\_x;}
\DoxyCodeLine{}
\DoxyCodeLine{onsites(p)\ \{}
\DoxyCodeLine{\ \ \ \ \textcolor{keyword}{auto}\ t\ =\ g[X\ +\ d];\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ X\ +-\/\ Direction\ fetches\ from\ neighbour\ site}}
\DoxyCodeLine{\ \ \ \ f[X]\ +=\ t\ +\ t*t;\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ can\ define\ variables\ in\ the\ loop\ \ \ }}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ h[X]\ =\ g[X\ +\ e\_x\ -\/\ 2*e\_y];\ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ non-\/nearest\ neighbour\ fetch\ (TODO:optimize!)}}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ \textcolor{keywordflow}{if}\ (X.coordinate(e\_t)\ ==\ 0)\ \{\ \ \ \ \ \ \textcolor{comment}{//\ Do\ this\ on\ 1st\ timeslice\ only}}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ h[X]\ *=\ 0.5;}
\DoxyCodeLine{\ \ \ \ \}}
\DoxyCodeLine{\}}

\end{DoxyCode}


{\ttfamily X} can be used only inside site loops. ~\newline
 Access operation {\ttfamily f\mbox{[}X\mbox{]}} can be applied only to field variables, and has the type of the field element (in the case above {\ttfamily mytype}).

{\ttfamily X} has methods\+:


\begin{DoxyItemize}
\item {\ttfamily Coordinate\+Vector X.\+coordinates()}\+: Coordinate\+Vector of the current site
\item {\ttfamily int X.\+coordinate(\+Direction)}\+: coordinate to direction
\item {\ttfamily Parity X.\+parity()}\+: parity of current site
\end{DoxyItemize}

The assignment {\ttfamily f\mbox{[}ALL\mbox{]} = 2 + g\mbox{[}X\mbox{]};} can also be done with {\ttfamily f = 2 + g}. The main difference is in sequencing\+: the first form goes through the lattice sites in one {\itshape site loop}, whereas the second stores the result of 2 + g to a temporary field variable which is copied to f (in this case std\+::moved). The site loop form is faster since it minimizes temporaries and memory accesses. ~\newline


Because {\ttfamily f\mbox{[}X\mbox{]}} is of type field element, the methods defined for the element type can be used. ~\newline
 {\ttfamily f\mbox{[}X\mbox{]}.dagger()} is ok, {\ttfamily f.\+dagger()} is not.

{\ttfamily f\mbox{[}X\mbox{]}} also serves as a visual identifier for a field variable access.

\doxylink{classReduction}{Reduction}\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{mytype\ d\ =\ 0;}
\DoxyCodeLine{onsites(ALL)\ d\ +=\ f[X]\ -\/\ g[X+e\_x];}
\DoxyCodeLine{}
\DoxyCodeLine{\mbox{\hyperlink{namespacehila_a7d333681d94db8e9eac675f2a7b5e3e6}{hila::out0}}\ <<\ \textcolor{stringliteral}{"{}The\ reduction\ is\ <<\ d\ <<\ std::endl;}}

\end{DoxyCode}


Other features\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{keywordtype}{double}\ a\ =\ 3,\ b\ =\ 5;}
\DoxyCodeLine{\mbox{\hyperlink{classField}{Field<double>}}\ f,\ g=0;}
\DoxyCodeLine{}
\DoxyCodeLine{onsites(ALL)\ \{}
\DoxyCodeLine{\ \ \ \ f[X]\ =\ (a\ +\ b);\ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ ok,\ loop\ extern\ variables\ a,b\ do\ not\ change\ within\ the\ loop}}
\DoxyCodeLine{\ \ \ \ b\ =\ f[X];\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ ERROR:\ cannot\ change\ a\ loop\ extern\ non-\/field\ variable\ (except\ reductions)}}
\DoxyCodeLine{\ \ \ \ \textcolor{keywordtype}{double}\ c\ =\ sin(f[X]);\ \ \ \ \ \ \textcolor{comment}{//\ ok,\ variable\ c\ defined\ within\ the\ loop}}
\DoxyCodeLine{\ \ \ \ f[X]\ =\ c\ +\ g;\ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ ERROR:\ using\ field\ variable\ g\ without\ [X]}}
\DoxyCodeLine{\}}
\DoxyCodeLine{}
\DoxyCodeLine{\mbox{\hyperlink{classCoordinateVector__t}{CoordinateVector}}\ v\ =\ \{0,1,1,0\};}
\DoxyCodeLine{}
\DoxyCodeLine{f\ =\ g.shift(v);\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ these\ two}}
\DoxyCodeLine{f[ALL]\ =\ g[X\ +\ v];\ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ are\ equivalent}}
\DoxyCodeLine{}
\DoxyCodeLine{f[EVEN]\ =\ g[X\ +\ v];\ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ Cannot\ be\ done\ with\ g.shift()\ alone}}

\end{DoxyCode}


Access field at a single point\+: {\ttfamily f\mbox{[}Coordinate\+Vector\mbox{]}}. This can be used only outside site loops.


\begin{DoxyCode}{0}
\DoxyCodeLine{\mbox{\hyperlink{classCoordinateVector__t}{CoordinateVector}}\ v\ =\ \{2,3,4,5\};}
\DoxyCodeLine{\textcolor{keyword}{auto}\ value\ =\ f[v];\ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ "{}value"{}\ is\ broadcast\ to\ all\ nodes!}}
\DoxyCodeLine{f[v]\ =\ 1;\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ In\ assignment,\ values\ are\ not\ broadcast:\ the\ node\ which}}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{comment}{//\ owns\ site\ v\ must\ have\ correct\ rhs.}}

\end{DoxyCode}
\hypertarget{md_docs_2guide_2hila__functionality_autotoc_md2}{}\doxysection{\texorpdfstring{Input library}{Input library}}\label{md_docs_2guide_2hila__functionality_autotoc_md2}
Class hila\+::input can be used to read parameters and other data for simulation programs. It matches key-\/value pairs from input files. As an example, if the file {\ttfamily parameters.\+dat} contains


\begin{DoxyCode}{0}
\DoxyCodeLine{\#\ this\ is\ a\ comment}
\DoxyCodeLine{\#\ Run\ parameters\ for\ run\ XYZ}
\DoxyCodeLine{}
\DoxyCodeLine{lattice\ size\ \ 64,\ 64,\ 64,\ 128}
\DoxyCodeLine{beta\ \ \ \ \ \ \ \ \ \ 5.4}
\DoxyCodeLine{clover\ \ \ \ \ \ \ \ perturbative}
\DoxyCodeLine{}
\DoxyCodeLine{loops\ \ \ \ \ \ \ \ \ 25000}
\DoxyCodeLine{seed\ \ \ \ \ \ \ \ \ \ 3474212}
\DoxyCodeLine{}
\DoxyCodeLine{coefficients\ \ \ \ 0.5,\ 0.7,\ 0.85,\ 1.3,\ 1.6,\ 2}
\DoxyCodeLine{labels\ \ \ \ \ \ \ \ setA,\ setB,\ setC}

\end{DoxyCode}


it can be read (mostly) using the method {\ttfamily input\+::get(std\+::string key)}\+:


\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{preprocessor}{\#include\ "{}hila.h"{}}}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{keywordtype}{int}\ main(\textcolor{keywordtype}{int}\ argc,\ \textcolor{keywordtype}{char}\ *\ argv[])\ \{}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ \mbox{\hyperlink{namespacehila_a88d54715010ef67cf2fbea84b00f76bb}{hila::initialize}}(argc,argv);}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ \textcolor{comment}{//\ open\ file\ after\ hila::initialize}}
\DoxyCodeLine{\ \ \ \ \textcolor{comment}{//\ here\ to\ variable\ p}}
\DoxyCodeLine{\ \ \ \ hila::input\ p(\textcolor{stringliteral}{"{}parameters.dat"{}});}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ \mbox{\hyperlink{classCoordinateVector__t}{CoordinateVector}}\ lsize\ =\ p.get(\textcolor{stringliteral}{"{}lattice\ size"{}});}
\DoxyCodeLine{\ \ \ \ \textcolor{keywordtype}{double}\ beta\ \ \ \ \ \ \ \ \ \ \ \ =\ p.get(\textcolor{stringliteral}{"{}beta"{}});}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ \textcolor{comment}{//\ Calling\ get\_item()\ as\ below\ means\ that\ allowed\ values\ for\ }}
\DoxyCodeLine{\ \ \ \ \textcolor{comment}{//\ "{}clover"{}\ are:\ \ "{}tree"{},\ "{}perturbative"{},\ or\ a\ float/double\ value.}}
\DoxyCodeLine{\ \ \ \ \textcolor{comment}{//\ Return\ value\ is\ 0,\ 1,\ 2\ respectively.}}
\DoxyCodeLine{\ \ \ \ \textcolor{keywordtype}{int}\ i\ =\ p.get\_item(\textcolor{stringliteral}{"{}clover"{}},\{\textcolor{stringliteral}{"{}tree"{}},\textcolor{stringliteral}{"{}perturbative"{}},\textcolor{stringliteral}{"{}\%f"{}}\});}
\DoxyCodeLine{\ \ \ \ \textcolor{keywordtype}{double}\ clover;}
\DoxyCodeLine{\ \ \ \ \textcolor{keywordflow}{if}\ (i\ ==\ 0)\ }
\DoxyCodeLine{\ \ \ \ \ \ \ \ clover\ =\ 1;}
\DoxyCodeLine{\ \ \ \ \textcolor{keywordflow}{else}\ \textcolor{keywordflow}{if}\ (i\ ==\ 1)\ }
\DoxyCodeLine{\ \ \ \ \ \ \ \ clover\ =\ <perturbative\ expression>;}
\DoxyCodeLine{\ \ \ \ \textcolor{keywordflow}{else}\ }
\DoxyCodeLine{\ \ \ \ \ \ \ \ clover\ =\ p.get();\ \ \textcolor{comment}{//\ the\ number\ is\ read\ here\ without\ key\ argument}}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ \textcolor{keywordtype}{int}\ loops\ \ \ \ \ \ \ =\ p.get(\textcolor{stringliteral}{"{}loops"{}});}
\DoxyCodeLine{\ \ \ \ \textcolor{keywordtype}{long}\ rng\_seed\ \ \ =\ p.get(\textcolor{stringliteral}{"{}seed"{}});}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ \textcolor{comment}{//\ reading\ a\ std::vector<>\ reads\ in\ comma-\/separated\ values}}
\DoxyCodeLine{\ \ \ \ \textcolor{comment}{//\ this\ reads\ in\ a\ vector\ of\ 6\ doubles}}
\DoxyCodeLine{\ \ \ \ std::vector<double>\ run\_coefficients\ =\ p.get(\textcolor{stringliteral}{"{}coefficients"{}});}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ \textcolor{comment}{//\ and\ this\ a\ vector\ of\ 3\ strings}}
\DoxyCodeLine{\ \ \ \ std::vector<std::string>\ labels\ \ \ \ \ \ =\ p.get(\textcolor{stringliteral}{"{}labels"{}});}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ \textcolor{comment}{//\ Close\ the\ file.\ File\ is\ also\ closed\ when\ p\ gets\ out\ of\ scope}}
\DoxyCodeLine{\ \ \ \ p.close();\ \ \ }
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ \textcolor{comment}{//\ lattice\ setup\ is\ convenient\ to\ do\ after\ parameters\ have\ been\ read}}
\DoxyCodeLine{\ \ \ \ lattice.\mbox{\hyperlink{classlattice__struct_a12f6b6a0c725399c8aa00740274b34b0}{setup}}(lsize);}

\end{DoxyCode}



\begin{DoxyItemize}
\item The method {\ttfamily input\+::get()} above deduces the type to be read in from the expected return value. The order is fixed, the items (lines) cannot be swapped (TODO\+: should this be allowed?). If an error occurs (wrong keys or values), program exits with an error message.
\item Because the order is fixed, the keys don\textquotesingle{}t really carry information for the program. However, they help to ensure that the values are as intended.
\item The method {\ttfamily input\+::get()} broadcasts the values to all nodes. They have to be called by all nodes simultaneously.
\item Method {\ttfamily input\+::get\+\_\+value()} has more options for synchronization and error returns. See documentation in {\ttfamily \doxylink{input_8h_source}{input.\+h}}
\end{DoxyItemize}\hypertarget{md_docs_2guide_2hila__functionality_autotoc_md3}{}\doxysection{\texorpdfstring{Check input and layout}{Check input and layout}}\label{md_docs_2guide_2hila__functionality_autotoc_md3}
The input files and the lattice layout can be checked with the commands (after the application program has been built) 
\begin{DoxyCode}{0}
\DoxyCodeLine{<hila-\/program-\/name>\ check}
\DoxyCodeLine{<hila-\/program-\/name>\ check=<number-\/of-\/nodes>\ \ \ \ \ \ \ \ \#\ without\ spaces}

\end{DoxyCode}
 This runs the program without initializing MPI, Cuda or other hardware features and exits at {\ttfamily lattice.\+setup()} before any large memory allocations are made. If the number-\/of-\/nodes argument is given, program reports how the node layout is done.

Example\+: if you built the {\ttfamily hila\+\_\+example} program above, in directory {\ttfamily hila/applications/hila\+\_\+example} the command {\ttfamily build/hila\+\_\+example check=32} checks the input file and the layout to 32 nodes.\hypertarget{md_docs_2guide_2hila__functionality_autotoc_md4}{}\doxysection{\texorpdfstring{HILA pre-\/processor tool}{HILA pre-processor tool}}\label{md_docs_2guide_2hila__functionality_autotoc_md4}
In short, the framework can be used in these steps\+:


\begin{DoxyEnumerate}
\item Write c++ code using the syntax and datatypes laid out below
\item Use the hilapp excecutable to convert this code into .cpt code
\item Compile the new .cpt code into the final excecutable
\end{DoxyEnumerate}



You can then use it to compile an extended C++ file into standard C++ using 
\begin{DoxyCode}{0}
\DoxyCodeLine{bin/hilapp\ path/to/program.cpp}

\end{DoxyCode}
 This will create a {\ttfamily cpt} file written in standard C++.

The {\ttfamily cpt} can be compiled with any c++ compiler, but must be linked against the headers and c++ files in the plumbing directory.

Check the example programs in the programs folder. You can use almost any standard C++ code, by there are a couple of new reserved names\+: the variable {\ttfamily X} and the function {\ttfamily onsites()}. In addition the framework defines a global {\ttfamily lattice} variable, which you should not overwrite.

In order to use the additional features for field type variables, you should inlude {\ttfamily \doxylink{field_8h}{plumbing/field.\+h}} in you program. You can also include one or more of the files in the {\ttfamily datatypes} folder, which contains predefined datatypes that can be used to construct a field. 