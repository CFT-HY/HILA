ADDITION = -DMSIZE=2
OPTS = -DNDIM=4  $(ADDITION)

#TRANSFORMER = ../../build/transformer -DPUHTI -DAVX -target:VECTORIZE=64 -I../../../llvm/lib/clang/8.0.1/include/ 
TRANSFORMER = ../../build/transformer -no-interleave -DAVX -DUSE_MPI -target:AVX -I/usr/lib/x86_64-linux-gnu/openmpi/include/ -I/usr/lib/openmpi/include/

CC = mpic++  -DUSE_MPI -mavx2 -mfma -DAVX

.PRECIOUS: %.cpt

CFLAGS = -Ofast $(OPTS)
CXXFLAGS = -Ofast -x c++ --std=c++17 $(OPTS)

%.exe: %.tr.o Makefile inputs.o mersenne_inline.o lattice.o setup_layout_generic.o map_node_layout_trivial.o com_mpi.o memalloc.o timers.o
	$(CC) -o $@ $< inputs.o mersenne_inline.o lattice.o setup_layout_generic.o map_node_layout_trivial.o com_mpi.o memalloc.o timers.o

%.cpt: %.cpp Makefile
	$(TRANSFORMER) $(ADDITION) $<

%.tr.o : %.cpt
	$(CC) $(CXXFLAGS) $< -c -o $@

%.tr.s : %.cpt
	$(CC) $(CXXFLAGS) $< -S -o $@

lattice.cpt : ../plumbing/lattice.cpp
	$(TRANSFORMER) $(ADDITION) $<

lattice.o : lattice.cpt
	$(CC) $(CXXFLAGS) $< -c

%.o : ../plumbing/%.cpp
	$(CC) $(CXXFLAGS) $< -c

%.o : %.cpp
	$(CC) $(CFLAGS) $< -c

%.o : %.c
	$(CC) $(CFLAGS) $< -c

clean:
	rm -rf *.o *.cpt

cleanall:
	rm -rf *.o *.cpt *.exe
