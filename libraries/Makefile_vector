# Edit MPI_INCLUDE_DIR here to point to the MPI header files
#
# This Makefile defines
#  HILAPP,
#    location of the hilapp binary, ../hilapp/build/hilapp
#  HILA_OBJECTS,
#    the list of objects that need to be included with an
#    application
#  HILA_OPTS
#    options that need to be passed to the C++ compiler and
#  HILA_INCLUDE,
#    the path to include files necessary to compile applications
#  with paremeters that compile vectorized code
#
# It also contains standard rules for compiling cpp files into
# object files placed in a build folder using hilapp and CC 
#


MPI_INCLUDE_DIR = /usr/lib/x86_64-linux-gnu/openmpi/include/


################

THIS_DIR := $(dir $(lastword $(MAKEFILE_LIST)))
HILA_INCLUDE = $(THIS_DIR)


HILA_OBJECTS = build/inputs.o build/mersenne_inline.o build/lattice.o build/setup_layout_vector.o build/map_node_layout_trivial.o build/com_mpi.o build/memalloc.o build/test_gathers.o


MPI_OPTS = -DUSE_MPI -I$(MPI_INCLUDE_DIR)


HILAPP =  $(THIS_DIR)/../hilapp/build/hilapp 
HILA_OPTS =  -target:AVX -DAVX -I$(HILA_INCLUDE) $(MPI_OPTS) -DSUBNODE_LAYOUT
HILA_CXX_FLAGS = $(CXXFLAGS) -DAVX -I$(HILA_INCLUDE) $(MPI_OPTS) -DSUBNODE_LAYOUT

HILA_LD_FLAGS = -lfftw3 -lm


build/%.cpt: $(THIS_DIR)/plumbing/%.cpp $(THIS_DIR)/Makefile
	echo $(THIS_DIR)
	$(HILAPP) $< $(OPTS) -o $@

# Standard rules for creating and building cpt files. These
# build .o files in the build folder by first running them
# through the 

build/%.cpt: %.cpp Makefile
	mkdir -p build
	$(HILAPP) $< $(OPTS) $(HILA_OPTS) -o $@

build/%.o : build/%.cpt
	$(CC) $(HILA_CXX_FLAGS) -DSUBNODE_LAYOUT $(OPTS) $< -c -o $@


build/%.cpt: $(THIS_DIR)/plumbing/%.cpp $(THIS_DIR)/Makefile
	$(HILAPP) $< $(OPTS) $(HILA_OPTS)  -o $@

